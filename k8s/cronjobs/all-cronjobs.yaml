---
# Log Compression CronJob
# Compresses log files older than 1 day
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mongo-log-compression
  namespace: banraiphisan
spec:
  # Run daily at midnight (0 0 * * *)
  schedule: "0 0 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          volumes:
            - name: mongo-logs
              nfs:
                server: sila-ipdc.warmipdc.intra.ais
                path: >-
                  /FS_MILKYWAY_LOG/legacy-portal-apis/logs/service/MONGO
          containers:
            - name: log-compressor
              image: alpine:latest
              command:
                - /bin/sh
                - -c
                - |
                  apk add --no-cache gzip findutils
                  echo "Compressing logs older than 1 day..."
                  find /logs -mtime +1 -type f -name "*.log*" \
                    ! -name "*.gz" -exec gzip '{}' \;
                  echo "Compression completed."
              volumeMounts:
                - name: mongo-logs
                  mountPath: /logs
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 256Mi
---
# Compressed Log Cleanup CronJob
# Deletes compressed log files older than 7 days
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mongo-compressed-log-cleanup
  namespace: banraiphisan
spec:
  # Run daily at 12:30 AM (30 0 * * *)
  schedule: "30 0 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          volumes:
            - name: mongo-logs
              nfs:
                server: sila-ipdc.warmipdc.intra.ais
                path: >-
                  /FS_MILKYWAY_LOG/legacy-portal-apis/logs/service/MONGO
          containers:
            - name: compressed-log-cleaner
              image: alpine:latest
              command:
                - /bin/sh
                - -c
                - |
                  apk add --no-cache findutils
                  echo "Cleaning up compressed logs older than 7 days..."
                  find /logs -mtime +7 -type f -name "*.gz" \
                    -exec rm -f '{}' \;
                  echo "Cleanup completed."
              volumeMounts:
                - name: mongo-logs
                  mountPath: /logs
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 256Mi
---
# General Log Cleanup CronJob
# Deletes all log files older than 30 days
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mongo-general-log-cleanup
  namespace: banraiphisan
spec:
  # Run daily at 1:30 AM (30 1 * * *)
  schedule: "30 1 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          volumes:
            - name: mongo-logs
              nfs:
                server: sila-ipdc.warmipdc.intra.ais
                path: >-
                  /FS_MILKYWAY_LOG/legacy-portal-apis/logs/service/MONGO
          containers:
            - name: general-log-cleaner
              image: alpine:latest
              command:
                - /bin/sh
                - -c
                - |
                  apk add --no-cache findutils
                  echo "Cleaning up all logs older than 30 days..."
                  # This is a safety cleanup that removes any files that
                  # might have been missed by the other cleanup jobs
                  find /logs -mtime +30 -type f -exec rm -f '{}' \;
                  echo "Cleanup completed."
              volumeMounts:
                - name: mongo-logs
                  mountPath: /logs
              resources:
                requests:
                  cpu: 100m
                  memory: 128Mi
                limits:
                  cpu: 500m
                  memory: 256Mi
